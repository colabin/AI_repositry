# JDATA
用户对品类下店铺的购买预测 https://jdata.jd.com/html/detail.html?id=8<br/>

赛题背景
京东零售集团坚持“以信赖为基础、以客户为中心的价值创造”这一经营理念，在不同的消费场景和连接终端上，在正确的时间、正确的地点为3亿多活跃用户提供最适合的产品和服务。目前，京东零售集团第三方平台签约商家超过21万个，实现了全品类覆盖，为维持商家生态繁荣、多样和有序，全面满足消费者一站式购物需求，需要对用户购买行为进行更精准地分析和预测。基于此，本赛题提供来自用户、商家、商品等多方面数据信息，包括商家和商品自身的内容信息、评论信息以及用户与之丰富的互动行为。参赛队伍需要通过数据挖掘技术和机器学习算法，构建用户购买商家中相关品类的预测模型，输出用户和店铺、品类的匹配结果，为精准营销提供高质量的目标群体。同时，希望参赛队伍通过本次比赛，挖掘数据背后潜在的意义，为电商生态平台的商家、用户提供多方共赢的智能解决方案。<br/>

2019.5.1 搭建baseline，调研了第一届的有关方案并根据本届比赛进行相应的修改，暂时不考虑对统计数据进行权重衰减，xgboost:0.0308, rank:8<br/>

2019.5.6 将logloss指标替换成auc指标，lgb线上 0.031896，xgboost线上0.03129，rank:38，说明了不平衡问题处理上auc指标具有一定的优势<br/>

2019.5.7 经过统计发现comment表，有一些情况比如，某个商品，好评数为20，差评数为1，另外一个商品好评数为50，差评数为30，那么对于这两个商品，统计好评和差评的ratio比统计好评差评次数更具有实际意义，另外对商品评论量取对数来减少量纲差异，经过xgboost特征重要性排序后发现comment重要性排名1，xgboost线上0.03163，rank:49，有一定提升；

2019.5.8 <br/>
1.采用网格搜索对lgb进行调优，线下auc提升2个点，但是线上指标并没有明显提升<br/>
2.尝试构造用户特征，查询了京东会员级别的成长模式，构造特征：2^会员级别除以账号使用时间（会员级别和购买力是正相关，除以使用时间表示升级速度，可以从一定程度上代表消费频率），没有明显提升<br/>

2019.5.9 <br/>
1.构建1|2|3|5|...|30时间区间内，用户行为（type 1-5）的min,mean,max统计特征，线下auc提升3个点，而且xgboost特征重要性打印出来是有部分特征排在了前列，但是线上0.029，有少许下降<br/>
2.为了和线上评价标准保持一致，自行构造线下评价指标（F11+F12）,测得线下0.028，和线上差不多，所以暂且将该目标作为我们线下的优化目标<br/>

2019.5.10 <br/>
1.利用店铺信息构造了涨粉速度，和涨会员速度，线上0.043，rank 35，这两个特征为强特，位于前5，原有的特征重要性排序出现了变化，比如用户的下单频率累计排在了第1<br/>
2.线上0.043的线下评价指标依然在0.03左右，所以线下指标构建可能有错误，准备进行重建<br/>
4.构建特征，用户对一个商品的最后一次某一操作的时间到预测日前的时间差,线下auc和特征重要性不占优<br/>
5.将xgboost替换为lgb模型并进行调优，线上0.047，rank 25<br/>
6.尝试了lgb模型 stacking和boosting，线下auc无明显提升<br/>

2019.5.11 <br/>
1.当前用户行为构建是根据1|2|3|5|...|30时间区间left join，相当于使用的预测日前一天有活动的用户构建的样本集，为了增大用户的样本数量，我们将用户活动时间扩大到3天和7天，即构建时间区间按照3|1|2|5|...|30，7|1|2|3|5|...|30进行left join，测的3天的结果和1天接近，均为0.047，7天的有所下降<br/>
2.构建了用户浏览行为，购物车行为的转化率，物品的被浏览，被加入购物车的转化率，线下auc提升4个点，特征排名在前5，待线上测试<br/>
3.重建线下评价指标，测得线上线下差异依然比较大，经过分析可能是val数据集和train数据集由同一时间区间（3.1-4.9）数据集split而来，val的提升只代表对于该时间区间的一种拟合，线上泛化性能不太好<br/>

2019.5.12 <br/>
1.往前滑7天，利用3.1-4.2构造一个训练集合，将和预测区间比较接近的3.1-4.9的做验证集，auc在0.83，线下评估指标只有0.045<br/>
2.分析了action的分布，在过年期间，用户的下单，浏览等行为明显变少，除此之外分布基本是一致的<br/>
3.因为训练集中只有4.8日有添加购物车行为，而预测集中4.9-4.15均有添加购物车操作，模型特征重要性显示购物车行为十分重要，经过分析可能会有这样一种情况就是，训练出来的模型会认为凡是有添加购物车行为的均会被打上1的标签，但是对于预测集来说，也许在9号添加到购物车的物品会在9号-15号之间就已经被购买，真实标签反而是0，导致预测错误，为了避免4.8日该日购物行为的过拟合影响，打算将预测模型拆分为2个模型，一个长期模型，包含浏览转化率，涨粉速度这些长期特征，另外一个模型包括加入购物车，浏览这些短期特征<br/>
4.为了确定长期模型训练集验证集的构造时间跨度，首先需要对用户的最小最大时间间隔进行统计，经过统计发现用户的平均购物间隔在30之内，所以暂时以30天为时间跨度进行训练集验证集构建，线下auc0.83<br/>
5.对用户的action进行时间权重衰减，无明显提升<br/>


2019.5.13<br/>
1.将user_id-cate-shop_id预测拆分为2步，先预测user-cate是否购买，再预测哪个店铺购买, 候选用户为4.8日有行为记录的用户，线上F11指标提升明显，达到0.09，然后shop_id根据目前效果最好的baseline（线上0.047）进行填充，线上0.052，rank10<br/>
2.F12指标仍然比较低，对于提升店铺的预测准确度进行分析，首先因为user-cate-shop是采用的4.8日，画图分析得4.8出现的组合相比于后七天购买的组合占比比较低，如果用前一天训练，某种角度来说限制了上限，所以打算将候选时间区间扩大到15天时间，线上提高0.5个点<br/>


目前的结论就是，如果一个特征对于auc提升很大，而且特征重要性排名靠前，那么这个特征很可能就是有用的，而且我们会将线下的结果和目前为止最优的结果进行交并比的计算，除了强特导致预测结果出现很大的变化外，我们一般认为可能较优的结果不会和当前最优结果有较大的交并比浮动<br/>

2019.5.16<br/>
1.对原始数据进行分析，发现对于(user,skuid)的建模方式，并不合适，因为对于商品的复购率很低低于1%，重新建模为(user，cate，shop),复购率达到10%。根据调整的模型调整特征。线上测试达到0.049<br/>
2.引入新特征,测试期间内,user购买/点击转化率，cate购买/点击转化率，shop购买/点击转化率，user购买/购物车转化率，cate购买/购物车转化率，shop购买/购物车转化率。<br/>
3.优化取Top的结果输出方法，首先根据原始数据滑动统计得出，1月对1周预测复购数为12858，所以对输出先过滤负值预测，在对(user，cate，shop)求和合并，排序后输出Top N，N取12858，线上测试达到0.052。更新单模型baseline。<br/>

2019.5.17<br/>
1.比赛评委老师提到将cate分类进行建模会是一个比较好的做法，推测是cate之中含有复购率比较高得日用品和及时性购买得奢侈品，所以使用不同得模型分别进行建模可能会有比较好的效果，将该思路拓展到user，shop，所以首先根据user，cate的分布进行统计，看能不能找到分类建模的依据<br/>
2.目前模型的特征比较多，可能会需要对特征进行筛选，对特征筛选方法进行调研<br/>
3.经过对用户的分析发现刷单用户的存在，占数据1%，对这部分用户需要进行去重和删除，没有明显的提升

2019.5.18<br/>
1.增加特征的多样性，调研特征交叉，特征组合，确定了往届top队伍的特征选择方案和cateboost方法用来进行特征组合<br/>
2.对模型进行cv调优<br/>

最终成绩<br/>
two-stage方案，首先对User-cate进行购买预测，根据购买概率进行召回(top召回和比例召回)，然后对于及时性购买品类，采用top3店铺进行扩充，进一步减小不平衡比率，然后采用不同时间区间训练模型，并且采用了stacking的思想进行特征拼接和模型融合，最终获得比赛的冠军<br/>

预测方案：<br/>
1.user-cate-sku-shop，一次预测<br/>
2.先预测user-cate是否购买，再预测哪个店铺购买，而且只需要考虑购买过的用户<br/>
3.基于业务的想法，有一些东西是要复购的。我们可以通过购买间隔什么的来确定是否会购买。这种时候构建的范围可以大一点，比如采用前1个月所有购买过的组合组成训练集。用目标区间确定是否是正样本构建一个集合。但是还有些东西它是及时消费。我们可以通过最近的行为来判断是否购买。这种构建区域就可以缩小，比如用前一个月所有没有购买过的组合组成训练集。用目标区间去确定是否是正样本<br/>
